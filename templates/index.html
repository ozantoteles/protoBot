<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>protoBot</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center">protoBot</h1>

    <!-- Chat log to display the conversation -->
    <div id="chat_log" class="mt-4" style="background-color: #f8f9fa; padding: 20px; border-radius: 5px; height: 300px; overflow-y: scroll;">
        <!-- Chat messages will be appended here -->
    </div>

    <div class="chatbox mt-4">
        <textarea id="user_input" class="form-control" rows="3" placeholder="Enter your instructions..."></textarea>
        <button id="generate_btn" class="btn btn-primary mt-2">Generate Code</button>
        <button id="reset_btn" class="btn btn-warning mt-2">Reset Chat</button>
    </div>

    <!-- Code output section -->
    <div id="code_output" class="mt-4" style="background-color: #e9ecef; padding: 20px; border-radius: 5px; white-space: pre-wrap; font-family: monospace;">
        <!-- Generated code will appear here -->
    </div>

    <!-- Serial port selection and upload -->
    <div class="mt-4">
        <label for="serial_ports">Select Serial Port:</label>
        <select id="serial_ports" class="form-control"></select>

        <div class="mt-3">
            <button id="compile_btn" class="btn btn-info">Compile Only</button>
            <button id="upload_btn" class="btn btn-success">Upload Only</button>
            <button id="compile_upload_btn" class="btn btn-primary">Compile & Upload</button>
        </div>
    </div>

    <!-- Upload/Compile status -->
    <div id="compile_upload_status" class="mt-4">
        <!-- Compile/upload status will appear here -->
    </div>
</div>

<!-- jQuery and Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
$(document).ready(function() {
    // Generate code button click
    $('#generate_btn').click(function() {
        let user_input = $('#user_input').val();
        if (!user_input) {
            alert('Please enter your instructions.');
            return;
        }

        // Append user message to the chat log
        $('#chat_log').append('<div><strong>You:</strong> ' + user_input + '</div>');

        // Clear the user input
        $('#user_input').val('');

        $('#code_output').text('Generating code...');
        $.ajax({
            url: '/generate_code',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 'user_input': user_input }),
            success: function(response) {
                // Append the assistant's response to the chat log
                $('#chat_log').append('<div><strong>Bot:</strong> ' + response.code + '</div>');

                // Display the generated code in the code output section
                $('#code_output').text(response.code);
            },
            error: function() {
                $('#code_output').text('Error generating code.');
            }
        });
    });

    // Reset chat button click
    $('#reset_btn').click(function() {
        $.post('/reset_chat', function(response) {
            if (response.status === 'success') {
                alert('Chat history cleared. Starting a new conversation.');
                $('#chat_log').empty();  // Clear the chat log on reset
                $('#code_output').text('');  // Clear the code output as well
            }
        });
    });

    // Get available serial ports on page load
    $.ajax({
        url: '/get_serial_ports',
        type: 'GET',
        success: function(ports) {
            let serial_ports = $('#serial_ports');
            let best_port = null;
            ports.forEach(function(port) {
                serial_ports.append(new Option(port.description + ' (' + port.device + ')', port.device));
                if (port.description.includes('USB') || port.description.includes('Serial')) {
                    best_port = port.device;
                }
            });
            if (best_port) {
                $('#serial_ports').val(best_port);
            }
        },
        error: function() {
            alert('Error fetching serial ports.');
        }
    });

        // Compile-only button click
    $('#compile_btn').click(function() {
        performAction('compile');
    });

    // Upload-only button click
    $('#upload_btn').click(function() {
        performAction('upload');
    });

    // Compile & Upload button click
    $('#compile_upload_btn').click(function() {
        performAction('compile_upload');
    });

    // Perform action (compile, upload, or both)
    function performAction(action) {
        let code = $('#code_output').text();
        let port = $('#serial_ports').val();
        if (!code || code === 'Generating code...' || code === 'Error generating code.') {
            alert('No valid code to upload. Please generate code first.');
            return;
        }
        if (!port) {
            alert('Please select a serial port.');
            return;
        }

        $('#compile_upload_status').text(`${capitalize(action.replace('_', ' '))} in progress...`);

        $.ajax({
            url: '/perform_action',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 'code': code, 'port': port, 'action': action }),
            success: function(response) {
                // Show the output of the compile/upload process
                $('#compile_upload_status').text(response.message);
            },
            error: function(xhr) {
                let errorMsg = 'Error during action.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg += '\n' + xhr.responseJSON.message;
                }
                $('#compile_upload_status').text(errorMsg);
            }
        });
    }

    // Capitalize the first letter of the action
    function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
});
</script>
</body>
</html>
